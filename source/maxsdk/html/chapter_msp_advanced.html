<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Max 6 API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
</head>
<body>
<div id="top"><!-- do not remove this div! -->
<div id="titlearea">
	<div id="c74header">
		<img src="header.png" height="100" />
	</div>
</div>
<!-- Generated by Doxygen 1.8.9.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('chapter_msp_advanced.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Advanced Signal Object Topics </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here are some techniques for implementing additional features found in most signal objects.</p>
<h1><a class="anchor" id="chapter_msp_advanced_internal_state"></a>
Saving Internal State</h1>
<p>To implement unit generators such as filters and ramp generators, you need to save internal state between calls to your object's perform routine. Here is a very simple low-pass filter (it just averages successive samples) that saves the value of the last sample in a vector to be averaged with the first sample of the next vector. First we add a field to our data structure to hold the value:</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>_myfilter</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structt__pxobject.html">t_pxobject</a> f_obj;</div>
<div class="line">    <span class="keywordtype">double</span>     f_sample;</div>
<div class="line">} t_myfilter;</div>
</div><!-- fragment --><p>Then, in our dsp method, we pass a pointer to the object as one of the DSP chain arguments. The dsp method also initializes the value of the internal state, to avoid any noise when the audio starts.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> myfilter_dsp64(t_myfilter *x, <a class="code" href="structt__object.html">t_object</a> *dsp64, <span class="keywordtype">short</span> *count, <span class="keywordtype">double</span> samplerate, <span class="keywordtype">long</span> maxvectorsize, <span class="keywordtype">long</span> flags)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__obj.html#gae740749094827ac5adc2b7145db1c596">object_method</a>(dsp64, <a class="code" href="group__symbol.html#ga5d8db08b384aeb76eaee85a15f46fbcb">gensym</a>(<span class="stringliteral">&quot;dsp_add64&quot;</span>), x, myfilter_perform64, 0, NULL);</div>
<div class="line">    x-&gt;f_sample = 0.0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Here is the perform routine, which obtains the internal state before entering the processing loop, then stores the most recent value after the loop is finished.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> myfilter_perform64(t_myfilter *x, <a class="code" href="structt__object.html">t_object</a> *dsp64, <span class="keywordtype">double</span> **ins, <span class="keywordtype">long</span> numins, <span class="keywordtype">double</span> **outs, <span class="keywordtype">long</span> numouts, <span class="keywordtype">long</span> sampleframes, <span class="keywordtype">long</span> flags, <span class="keywordtype">void</span> *userparam)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">double</span>    *in = ins[0];        <span class="comment">// first inlet</span></div>
<div class="line">    <span class="keywordtype">double</span>    *out = outs[0];      <span class="comment">// first outlet</span></div>
<div class="line">    <span class="keywordtype">int</span>       n = sampleframes;    <span class="comment">// vector size</span></div>
<div class="line">    <span class="keywordtype">double</span>    samp = x-&gt;f_sample;  <span class="comment">// read from internal state</span></div>
<div class="line">    <span class="keywordtype">double</span>    val;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">while</span> (n--) {</div>
<div class="line">        val = *in++;</div>
<div class="line">         *out++ = (val + samp) * 0.5;</div>
<div class="line">        samp = val;</div>
<div class="line">    }</div>
<div class="line">    x-&gt;f_sample = samp;            <span class="comment">// save to internal state</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="chapter_msp_advanced_connections"></a>
Using Connection Information</h1>
<p>The third argument to the dsp method is an array of numbers that enumerate the number of objects connected to each of your objects inputs and outputs. More advanced dsp methods can use this information for optimization purposes. For example, if you find that your object has no inputs or outputs, you could avoid calling 'dsp_add64' altogether. The MSP signal operator objects (such as +~ and *~) use this to implement a basic polymorphism: they look at the connections count to determine whether the perform routine should use scalar or signal inputs. For example, if the right input has no connected signals, the user can add a scalar value sent to the right inlet.</p>
<p>To implement this behavior, you have a few different options. The first option is to write two different perform methods, one which handles the two-signal case, and one which handles the scalar case. The dsp method looks at the <code>count</code> array and passes a different function to dsp_add64.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span> (count[1])   <span class="comment">// signal connected to second inlet</span></div>
<div class="line">    <a class="code" href="group__obj.html#gae740749094827ac5adc2b7145db1c596">object_method</a>(dsp64, <a class="code" href="group__symbol.html#ga5d8db08b384aeb76eaee85a15f46fbcb">gensym</a>(<span class="stringliteral">&quot;dsp_add64&quot;</span>), x, mydspobject_twosigperform64, 0, NULL);</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">    <a class="code" href="group__obj.html#gae740749094827ac5adc2b7145db1c596">object_method</a>(dsp64, <a class="code" href="group__symbol.html#ga5d8db08b384aeb76eaee85a15f46fbcb">gensym</a>(<span class="stringliteral">&quot;dsp_add64&quot;</span>), x, mydspobject_scalarperform64, 0, NULL);</div>
</div><!-- fragment --><p>The second option is to store the value of the count array for a particular signal in your object's struct. Then the perform method can make the decision whether to use the signal value or a scalar value that has been stored by the object. In this case, many objects use a single sample value from the signal as a substitute for the scalar. Using the first sample (i.e., the value at index 0) is a technique that works for any vector size, since vector sizes could be as small as a single sample. Here is an example of this technique for an object that has two inputs and one output. The connection count for the right input signal is stored in a struct member named m_count:</p>
<div class="fragment"><div class="line">x-&gt;m_count = count[1];</div>
<div class="line"><a class="code" href="group__obj.html#gae740749094827ac5adc2b7145db1c596">object_method</a>(dsp64, <a class="code" href="group__symbol.html#ga5d8db08b384aeb76eaee85a15f46fbcb">gensym</a>(<span class="stringliteral">&quot;dsp_add64&quot;</span>), x, mydspobject_perform64, 0, NULL);</div>
</div><!-- fragment --><p>Here is a perform routine that uses the connection count information as passed in the format shown above:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> mydspobject_perform64(t_mydspobject *x, <a class="code" href="structt__object.html">t_object</a> *dsp64, <span class="keywordtype">double</span> **ins, <span class="keywordtype">long</span> numins, <span class="keywordtype">double</span> **outs, <span class="keywordtype">long</span> numouts, <span class="keywordtype">long</span> sampleframes, <span class="keywordtype">long</span> flags, <span class="keywordtype">void</span> *userparam)</div>
<div class="line">{</div>
<div class="line">    t_mydspobject *x = (t_mydspobject *)w[1];</div>
<div class="line">    <span class="keywordtype">int</span>           connected = x-&gt;m_count;</div>
<div class="line">    <span class="keywordtype">double</span>        *in = ins[0];</div>
<div class="line">    <span class="keywordtype">double</span>        *in2 = ins[1];</div>
<div class="line">    <span class="keywordtype">double</span>        *out = outs[0];</div>
<div class="line">    <span class="keywordtype">int</span>           n = sampleframes;</div>
<div class="line">    <span class="keywordtype">double</span>        in2value;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// get scalar sample or use signal depending on whether signal is connected</span></div>
<div class="line">    in2value = connected ? *in2 : x-&gt;m_scalarvalue;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// do calculation here</span></div>
<div class="line">    <span class="comment">// ...</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="chapter_msp_advanced_buffers"></a>
Working with Buffer Objects</h1>
<p>To access a named buffer~ object for either reading or writing sample values, refer to the <a class="el" href="group__buffers.html">Buffers</a> reference. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
		<div id="c74footer">
			&nbsp;&nbsp;Copyright &copy; 2013, <a href="http://www.cycling74.com/">Cycling '74</a>
		</div>
	</body>
</html>
